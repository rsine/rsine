@prefix spin: <http://spinrdf.org/sp/> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix rsine: <http://lod2.eu/rsine/> .
@prefix dcterms: <http://purl.org/dc/terms/>.

<http://example.org/aligned/new_account> a rsine:Subscription;
    rsine:query [
        dcterms:description "Notification user account creation";

        spin:text "PREFIX cs:<http://purl.org/vocab/changeset/schema#>
            PREFIX spin:<http://spinrdf.org/sp/>
            PREFIX rdf:<http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
            PREFIX void:<http://rdfs.org/ns/void#>
            PREFIX dct:<http://purl.org/dc/terms/>
            PREFIX swcs:<http://schema.semantic-web.at/ppt/>
            PREFIX rdfs:<http://www.w3.org/2000/01/rdf-schema#>
            PREFIX swcu:<http://schema.semantic-web.at/users/>

            SELECT ?userName (GROUP_CONCAT(?auth; separator=', ') AS ?auths) WHERE {
                ?cs a cs:ChangeSet;
                    cs:createdDate ?csdate;
                    cs:addition ?userAdd;
                    cs:addition ?userAuth;
                    cs:addition ?userInfo.

                ?userAdd rdf:subject ?user;
                    rdf:predicate rdf:type;
                    rdf:object swcu:User.

                ?userAuth rdf:subject ?user;
                    rdf:predicate swcu:grantedAuthority;
                    rdf:object ?auth.

                ?userInfo rdf:subject ?user;
                    rdf:predicate swcu:username;
                    rdf:object ?userName.

                FILTER (?csdate > 'QUERY_LAST_ISSUED'^^<http://www.w3.org/2001/XMLSchema#dateTime>)
            }
            GROUP BY ?userName HAVING (STRLEN(?auths) > 0)
            ";

        rsine:formatter [
            a rsine:vtlFormatter;
            rsine:message "A new user named '$bindingSet.getValue('userName').getLabel()' with the roles '$bindingSet.getValue('auths').getLabel()' has been created by user <unsupported>.";
        ]
    ];

    rsine:notifier [
        a rsine:loggingNotifier;
    ].